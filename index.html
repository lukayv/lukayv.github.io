<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeQuest AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&family=Roboto+Mono:wght@400;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">

    <style>
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-primary: #22d3ee;
            --accent-secondary: #67e8f9;
            --font-main: 'Inter', sans-serif;
            --font-game: 'Press Start 2P', cursive;
            --font-mono: 'Roboto Mono', monospace;
        }

        
        [data-theme="futurista"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-primary: #22d3ee;
            --accent-secondary: #67e8f9;
            --font-main: 'Inter', sans-serif;
            --font-game: 'Press Start 2P', cursive;
            --font-mono: 'Roboto Mono', monospace;
        }

        [data-theme="medieval"] {
            --bg-primary: #2c1e19;
            --bg-secondary: #4a3831;
            --bg-tertiary: #6e5549;
            --text-primary: #e6cda5;
            --text-secondary: #bda27e;
            --accent-primary: #e6c07a;
            --accent-secondary: #f2d79b;
            --font-main: 'MedievalSharp', cursive;
            --font-game: 'MedievalSharp', cursive;
            --font-mono: 'MedievalSharp', cursive;
        }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .font-game { font-family: var(--font-game); }
        .font-mono { font-family: var(--font-mono); }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--accent-primary); }
        .border-accent { border-color: var(--accent-primary); }

        .progress-bar-inner, .attribute-bar-inner { transition: width 0.5s ease-in-out; }
        .chat-message { display: flex; flex-direction: column; max-width: 85%; }
        .chat-bubble { overflow-wrap: break-word; }
        .chat-message.user { align-self: flex-end; align-items: flex-end; }
        .chat-message.other { align-self: flex-start; align-items: flex-start; }
        .chat-bubble-user { background-color: #1e40af; color: white; }
        .chat-bubble-ai { background-color: var(--bg-secondary); color: var(--text-primary); }
        #ai-chatbox::-webkit-scrollbar, #progress-analysis-box::-webkit-scrollbar, #community-chat-box::-webkit-scrollbar, #mission-library-list::-webkit-scrollbar { width: 8px; }
        #ai-chatbox::-webkit-scrollbar-track, #progress-analysis-box::-webkit-scrollbar-track, #community-chat-box::-webkit-scrollbar-track, #mission-library-list::-webkit-scrollbar-track { background: var(--bg-secondary); }
        #ai-chatbox::-webkit-scrollbar-thumb, #progress-analysis-box::-webkit-scrollbar-thumb, #community-chat-box::-webkit-scrollbar-thumb, #mission-library-list::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        .attribute-bar { background-color: var(--bg-tertiary); }
        .strength-bar { background-color: #ef4444; }
        .intelligence-bar { background-color: #3b82f6; }
        .charisma-bar { background-color: #eab308; }
        .vitality-bar { background-color: #22c55e; }
        .creativity-bar { background-color: #a855f7; }
        .wisdom-bar { background-color: #2dd4bf; }
        .discipline-bar { background-color: #f97316; }
        .avatar-preview-bg {
            background: radial-gradient(circle, color-mix(in srgb, var(--accent-primary) 30%, transparent) 0%, rgba(20,26,48,0) 70%);
        }
        .tab-btn.active { border-color: var(--accent-primary); color: var(--accent-primary); }
        .mission-section-title {
            font-family: var(--font-game);
            font-size: 0.9rem;
            color: var(--accent-secondary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--bg-tertiary);
        }
        .mission-countdown { font-size: 0.75rem; color: var(--text-secondary); }
        .mission-description {
            font-size: 0.8rem;
            color: var(--text-primary);
            background-color: color-mix(in srgb, var(--bg-secondary) 50%, transparent);
            padding: 8px;
            border-radius: 6px;
            margin-top: 6px;
        }
        
        .level-up-modal-content {
            background-color: rgba(10, 15, 30, 0.9);
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-primary), 0 0 30px var(--accent-primary) inset;
            backdrop-filter: blur(5px);
        }

        .next-perk {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 4px;
        }
        .class-card { transition: all 0.2s ease-in-out; }
        .class-card:hover { transform: translateY(-5px); border-color: var(--accent-primary); }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body data-theme="futurista">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="font-game text-3xl md:text-4xl text-accent" style="text-shadow: 0 0 8px var(--accent-primary);">LifeQuest AI</h1>
            <p class="text-secondary mt-2">O seu assistente pessoal para uma vida épica.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Character Sheet -->
            <aside class="lg:col-span-1">
                <div class="bg-secondary/50 backdrop-blur-sm rounded-xl p-5 border border-tertiary shadow-lg sticky top-6">
                    <h2 class="text-xl font-bold mb-4 text-center border-b border-tertiary pb-3 font-mono">Painel do Herói</h2>
                    <div class="flex flex-col items-center mb-4">
                        <div id="profile-picture-container" class="w-32 h-32 mb-3 avatar-preview-bg rounded-full flex items-center justify-center relative overflow-hidden p-2 cursor-pointer group">
                             <img id="profile-picture-img" class="w-full h-full object-cover rounded-full hidden" src="">
                             <i id="profile-picture-icon" data-lucide="user-round" class="w-24 h-24 text-accent/70"></i>
                             <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="camera" class="w-8 h-8"></i>
                             </div>
                        </div>
                        <div id="hero-name-display" class="font-semibold text-lg text-green-400">Herói do Cotidiano</div>
                         <div id="hero-title-display" class="text-sm text-yellow-400 mt-1"></div>
                         <div id="class-display" class="font-game text-sm text-yellow-400 mt-1"></div>
                        <div id="level-display" class="font-game text-lg text-purple-400">LVL 1</div>
                    </div>
                    <div class="mb-4">
                        <div class="flex justify-between items-center text-sm mb-1 font-mono">
                            <span class="font-semibold text-primary">XP GERAL</span>
                            <span id="xp-text" class="text-secondary">0 / 100</span>
                        </div>
                        <div class="w-full bg-tertiary h-4 border-2 border-tertiary progress-bar-container">
                            <div id="xp-bar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-full progress-bar-inner" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="flex justify-around items-center mb-6 text-center">
                        <div>
                            <div class="text-xs text-secondary font-mono">OURO</div>
                            <div class="flex items-center gap-1">
                                <i class="lucide-icon text-yellow-400 w-5 h-5" data-lucide="coins"></i>
                                <span id="gold-display" class="text-yellow-400 font-bold text-lg font-mono">0</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-secondary font-mono">RITMO</div>
                            <div class="flex items-center gap-1">
                                <i class="lucide-icon text-blue-400 w-5 h-5" data-lucide="timer"></i>
                                <span id="avg-time-display" class="text-blue-400 font-bold text-sm font-mono">--:--:--</span>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mb-3 text-center font-mono">Atributos</h3>
                    <div id="attributes-list" class="space-y-4"></div>
                </div>
            </aside>

            <!-- Right Column: Main Content -->
            <main class="lg:col-span-2">
                 <div class="mb-6">
                    <div class="flex border-b border-tertiary flex-wrap">
                        <button data-tab="tasks" class="tab-btn flex-1 py-3 px-2 text-center font-semibold border-b-2 flex items-center justify-center gap-2 active">
                            <i class="lucide-icon" data-lucide="swords"></i> Missões
                        </button>
                        <button data-tab="coach" class="tab-btn flex-1 py-3 px-2 text-center font-semibold border-b-2 border-transparent text-secondary hover:text-primary transition-colors flex items-center justify-center gap-2">
                            <i class="lucide-icon" data-lucide="brain-circuit"></i> ISK IA
                        </button>
                         <button data-tab="shop" class="tab-btn flex-1 py-3 px-2 text-center font-semibold border-b-2 border-transparent text-secondary hover:text-primary transition-colors flex items-center justify-center gap-2">
                            <i class="lucide-icon" data-lucide="shopping-cart"></i> Loja
                        </button>
                        <button data-tab="community" class="tab-btn flex-1 py-3 px-2 text-center font-semibold border-b-2 border-transparent text-secondary hover:text-primary transition-colors flex items-center justify-center gap-2">
                            <i class="lucide-icon" data-lucide="users"></i> Comunidade
                        </button>
                        <button data-tab="profile" class="tab-btn flex-1 py-3 px-2 text-center font-semibold border-b-2 border-transparent text-secondary hover:text-primary transition-colors flex items-center justify-center gap-2">
                            <i class="lucide-icon" data-lucide="settings"></i> Perfil
                        </button>
                    </div>
                </div>

                <div id="content-tasks" class="tab-content">
                    <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary space-y-6">
                         <!-- Missão de Classe -->
                        <div id="class-mission-container" class="hidden">
                             <h3 class="mission-section-title text-yellow-300 border-yellow-400/50">MISSÃO DE CLASSE</h3>
                            <div id="class-task-list" class="space-y-3"></div>
                        </div>
                        <!-- Missões Diárias -->
                        <div>
                            <div class="flex justify-between items-center">
                                <h3 class="mission-section-title">DIÁRIAS</h3>
                                <div class="flex items-center gap-4">
                                    <div id="daily-swap-counter" class="mission-countdown font-mono"></div>
                                    <div id="daily-countdown" class="mission-countdown font-mono"></div>
                                </div>
                            </div>
                            <div id="daily-task-list" class="space-y-3"></div>
                        </div>
                        <!-- Missões Semanais -->
                         <div>
                            <div class="flex justify-between items-center">
                                <h3 class="mission-section-title">SEMANAIS</h3>
                                <div class="flex items-center gap-4">
                                    <div id="weekly-swap-counter" class="mission-countdown font-mono"></div>
                                    <div id="weekly-countdown" class="mission-countdown font-mono"></div>
                                </div>
                            </div>
                            <div id="weekly-task-list" class="space-y-3"></div>
                        </div>
                        <!-- Missões Mensais -->
                         <div>
                            <div class="flex justify-between items-center">
                                <h3 class="mission-section-title">MENSAIS</h3>
                                 <div class="flex items-center gap-4">
                                    <div id="monthly-swap-counter" class="mission-countdown font-mono"></div>
                                    <div id="monthly-countdown" class="mission-countdown font-mono"></div>
                                </div>
                            </div>
                            <div id="monthly-task-list" class="space-y-3"></div>
                        </div>
                         <!-- Missão Bônus -->
                        <div id="bonus-mission-container" class="hidden">
                             <h3 class="mission-section-title text-yellow-300 border-yellow-400/50">BÔNUS ESPECIAL</h3>
                            <div id="bonus-task-list" class="space-y-3"></div>
                        </div>
                        <!-- Criar Missão -->
                        <div class="border-t border-tertiary pt-6">
                             <button id="toggle-create-mission-btn" class="w-full flex justify-between items-center">
                                <h3 class="mission-section-title mb-0 pb-0 border-none">CRIAR MISSÕES PERSONALIZADAS</h3>
                                <i id="create-mission-chevron" class="lucide-icon transition-transform" data-lucide="chevron-down"></i>
                             </button>
                             <div id="create-mission-content" class="collapsible-content space-y-4 pt-4">
                                 <form id="add-daily-mission-form" class="space-y-3 p-2 sm:p-4 bg-black/20 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm font-semibold">Missão Diária</p>
                                        <button type="button" class="show-library-btn text-xs bg-tertiary hover:bg-opacity-70 px-2 py-1 rounded-md" data-modality="daily">Usar Guardada</button>
                                    </div>
                                    <input type="text" id="new-daily-mission-text" placeholder="Qual é a sua missão diária?" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <select id="new-daily-mission-attribute" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                        <!-- Options populated by JS -->
                                    </select>
                                    <button type="submit" id="add-daily-mission-btn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                        <i class="lucide-icon" data-lucide="plus-circle"></i> 
                                        <span id="add-daily-mission-btn-text">Adicionar Missão</span>
                                    </button>
                                 </form>
                                 <form id="add-weekly-mission-form" class="space-y-3 p-2 sm:p-4 bg-black/20 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm font-semibold">Missão Semanal</p>
                                        <button type="button" class="show-library-btn text-xs bg-tertiary hover:bg-opacity-70 px-2 py-1 rounded-md" data-modality="weekly">Usar Guardada</button>
                                    </div>
                                    <input type="text" id="new-weekly-mission-text" placeholder="Qual é a sua missão semanal?" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <select id="new-weekly-mission-attribute" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                         <!-- Options populated by JS -->
                                    </select>
                                    <button type="submit" id="add-weekly-mission-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                        <i class="lucide-icon" data-lucide="plus-circle"></i> 
                                        <span id="add-weekly-mission-btn-text">Adicionar Missão</span>
                                    </button>
                                 </form>
                                 <form id="add-monthly-mission-form" class="space-y-3 p-2 sm:p-4 bg-black/20 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm font-semibold">Missão Mensal</p>
                                        <button type="button" class="show-library-btn text-xs bg-tertiary hover:bg-opacity-70 px-2 py-1 rounded-md" data-modality="monthly">Usar Guardada</button>
                                    </div>
                                    <input type="text" id="new-monthly-mission-text" placeholder="Qual é a sua missão mensal?" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <select id="new-monthly-mission-attribute" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                         <!-- Options populated by JS -->
                                    </select>
                                    <button type="submit" id="add-monthly-mission-btn" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                        <i class="lucide-icon" data-lucide="plus-circle"></i> 
                                        <span id="add-monthly-mission-btn-text">Adicionar Missão</span>
                                    </button>
                                 </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="content-coach" class="tab-content hidden space-y-8">
                     <!-- AI Chat -->
                    <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="lucide-icon mr-2" data-lucide="brain-circuit"></i> Fale com a ISK IA</h2>
                        <div id="ai-chatbox" class="h-[30rem] bg-black/20 rounded-lg p-4 overflow-y-auto mb-4 border border-tertiary flex flex-col gap-4"></div>
                        <div class="relative">
                            <textarea id="ai-input" placeholder="Peça um conselho, defina uma meta..." class="w-full bg-tertiary border border-tertiary rounded-lg px-4 py-3 pr-20 h-24 resize-none focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
                            <button id="ai-send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold p-3 rounded-full transition-colors disabled:bg-gray-500">
                                <i id="send-icon" class="lucide-icon" data-lucide="send"></i>
                                <i id="loading-spinner" class="lucide-icon animate-spin hidden" data-lucide="loader-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Progress Analysis -->
                    <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary">
                        <h2 class="text-2xl font-bold mb-6 flex items-center"><i class="lucide-icon mr-2" data-lucide="line-chart"></i> Análise de Progresso</h2>
                        <h3 class="text-lg font-semibold mb-3">Missões Concluídas por Atributo</h3>
                        <div id="progress-charts" class="space-y-3 mb-6"></div>
                        <h3 class="text-lg font-semibold mb-3">Análise da ISK IA</h3>
                        <button id="analyze-progress-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i id="analyze-icon" class="lucide-icon" data-lucide="lightbulb"></i>
                            <i id="analyze-spinner" class="lucide-icon animate-spin hidden" data-lucide="loader-circle"></i>
                            Analisar meu progresso
                        </button>
                        <div id="progress-analysis-box" class="mt-4 h-64 bg-black/20 rounded-lg p-4 overflow-y-auto border border-tertiary text-secondary">
                            Clique no botão acima para receber feedback personalizado da sua ISK IA.
                        </div>
                    </div>
                </div>

                 <div id="content-shop" class="tab-content hidden">
                     <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary text-center">
                         <h2 class="text-2xl font-bold mb-6 flex items-center justify-center gap-2"><i class="lucide-icon" data-lucide="shopping-cart"></i> Loja de Recompensas</h2>
                         <i class="lucide-icon w-24 h-24 text-yellow-400 mx-auto mb-4" data-lucide="gem"></i>
                         <p class="text-primary mb-2">Em breve, poderá usar o seu Ouro aqui!</p>
                         <p class="text-secondary text-sm mb-6">O que gostaria de ver na loja?</p>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                             <div class="bg-tertiary/50 p-4 rounded-lg"> <h3 class="font-semibold text-accent mb-2">Temas para a Interface</h3> <p class="text-xs text-secondary">Personalize as cores e o visual da aplicação para combinar com o seu estilo.</p> </div>
                             <div class="bg-tertiary/50 p-4 rounded-lg"> <h3 class="font-semibold text-green-400 mb-2">Boosts de XP</h3> <p class="text-xs text-secondary">Compre itens que dobram o XP ganho por um dia inteiro para acelerar a sua evolução.</p> </div>
                             <div class="bg-tertiary/50 p-4 rounded-lg"> <h3 class="font-semibold text-purple-400 mb-2">Passes de Missão</h3> <p class="text-xs text-secondary">Use o ouro para substituir uma missão diária que não queira fazer ou para gerar uma missão extra.</p> </div>
                         </div>
                     </div>
                 </div>

                <div id="content-community" class="tab-content hidden">
                    <div id="community-list-view">
                         <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary space-y-8">
                             <div>
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="share-2"></i> O seu ID de Amigo</h2>
                                <div class="bg-black/20 p-4 rounded-lg text-center">
                                    <p id="user-id-display" class="font-mono text-2xl tracking-widest text-green-400">0000000000</p>
                                    <p class="text-xs text-secondary mt-2">Partilhe este código para que os seus amigos o possam adicionar.</p>
                                </div>
                             </div>
                             <div>
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="user-plus"></i> Adicionar Amigos</h2>
                                <div class="flex gap-2">
                                    <input type="text" placeholder="Insira o ID do seu amigo..." class="flex-grow bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <button class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                                </div>
                             </div>
                             <div>
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="users-2"></i> Meus Amigos</h2>
                                <div id="friends-list" class="space-y-3">
                                    <p class="text-secondary text-center italic">A sua lista de amigos está vazia.</p>
                                </div>
                             </div>
                             <div>
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="users"></i> Comunidades</h2>
                                <div id="community-list" class="space-y-3">
                                    <div class="bg-tertiary/50 p-4 rounded-lg flex justify-between items-center border border-tertiary"><div><h3 class="font-semibold text-accent">Leitores Vorazes</h3><p class="text-xs text-secondary">Para quem tem metas de leitura.</p></div><button class="join-community-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-1 px-3 rounded-lg text-sm" data-community-name="Leitores Vorazes">Entrar</button></div>
                                    <div class="bg-tertiary/50 p-4 rounded-lg flex justify-between items-center border border-tertiary"><div><h3 class="font-semibold text-red-400">Maratonistas do Brasil</h3><p class="text-xs text-secondary">Foco em corrida e fitness.</p></div><button class="join-community-btn bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-1 px-3 rounded-lg text-sm" data-community-name="Maratonistas do Brasil">Entrar</button></div>
                                </div>
                             </div>
                             <div>
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="plus-square"></i> Criar Comunidade</h2>
                                <div class="flex gap-2">
                                    <input type="text" id="new-community-name" placeholder="Nome da sua comunidade..." class="flex-grow bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <button id="create-community-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg">Criar</button>
                                </div>
                             </div>
                             <div id="hall-of-fame-container">
                                <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="trophy"></i> Salão da Fama</h2>
                                <div id="hall-of-fame-list" class="space-y-3">
                                    <!-- Hall of Fame will be rendered here -->
                                </div>
                             </div>
                        </div>
                    </div>
                    <div id="community-chat-view" class="hidden">
                        <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary">
                            <div class="flex items-center mb-4">
                                <button id="back-to-communities-btn" class="mr-4 p-2 hover:bg-tertiary rounded-full"><i data-lucide="arrow-left"></i></button>
                                <h2 id="community-chat-title" class="text-2xl font-bold"></h2>
                            </div>
                            <div id="community-chat-box" class="h-[30rem] bg-black/20 rounded-lg p-4 overflow-y-auto mb-4 border border-tertiary flex flex-col gap-4">
                                <!-- Chat content here -->
                            </div>
                            <div class="relative">
                                <input id="community-chat-input" type="text" placeholder="Envie uma mensagem..." class="w-full bg-tertiary border border-tertiary rounded-lg px-4 py-3 pr-16">
                                <button id="community-chat-send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-cyan-600 p-2 rounded-full hover:bg-cyan-500 transition-colors"><i data-lucide="send"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="content-profile" class="tab-content hidden">
                    <div class="bg-secondary/50 rounded-xl p-5 border border-tertiary space-y-8">
                         <div>
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="user-cog"></i> Configurações do Herói</h2>
                             <div class="mb-6">
                                <label for="hero-name-input" class="block text-sm font-medium text-secondary mb-1">Nome do Herói</label>
                                <input type="text" id="hero-name-input" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2" value="Herói do Cotidiano">
                            </div>
                            <div class="mb-6">
                                <label for="theme-selector" class="block text-sm font-medium text-secondary mb-1">Tema Visual</label>
                                <select id="theme-selector" class="w-full bg-tertiary border border-tertiary rounded-lg px-3 py-2">
                                    <option value="futurista">Futurista</option>
                                    <option value="medieval">Fantasia Medieval</option>
                                </select>
                            </div>
                         </div>
                         <div>
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="log-in"></i> Opções de Login</h2>
                            <div id="auth-buttons" class="space-y-4">
                                <button id="google-login-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="key-round"></i> Entrar com Google
                                </button>
                                 <button class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                     <i data-lucide="smartphone"></i> Entrar com Telemóvel
                                </button>
                            </div>
                             <div id="logout-section" class="hidden">
                                <p id="user-email" class="text-center text-secondary mb-4"></p>
                                <button id="logout-btn" class="w-full bg-tertiary hover:bg-opacity-70 text-primary font-bold py-3 px-4 rounded-lg">Sair</button>
                            </div>
                         </div>
                         <div id="titles-container">
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="award"></i> Títulos</h2>
                            <div id="titles-list" class="space-y-3">
                                <!-- Titles will be rendered here -->
                            </div>
                         </div>
                         <div id="class-perks-container" class="hidden">
                             <h2 id="class-perks-title" class="text-2xl font-bold mb-4 flex items-center gap-2"></h2>
                             <div id="class-perks-list" class="space-y-3"></div>
                         </div>
                         <div>
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="star"></i> Perks Gerais</h2>
                            <div id="perks-list" class="space-y-3">
                                <p class="text-gray-500 text-center italic">Aumente o nível dos seus atributos para desbloquear perks!</p>
                            </div>
                         </div>
                         <div>
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="lucide-icon" data-lucide="database-zap"></i> Gestão de Conta</h2>
                            <button id="reset-account-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="trash-2"></i> Resetar Conta
                            </button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <input type="file" id="profile-picture-input" class="hidden" accept="image/*">
    <div id="level-up-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
         <div id="level-up-card" class="level-up-modal-content rounded-xl p-8 text-center transform scale-95 transition-transform duration-300">
            <div class="flex items-center justify-center gap-2 font-mono text-lg text-accent border-b-2 border-accent/50 pb-2 mb-4">
                <i data-lucide="bell"></i>
                <span>NOTIFICAÇÃO DO SISTEMA</span>
            </div>
            <p id="new-level-text" class="text-2xl text-primary mb-6">Você alcançou o Nível 2!</p>
            <button id="close-modal-btn" class="font-semibold bg-accent text-primary px-6 py-2 rounded-lg hover:bg-opacity-80 transition-colors">Continuar</button>
        </div>
    </div>

    <div id="class-selection-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
         <div class="bg-secondary border border-accent rounded-xl p-8 text-center max-w-4xl">
            <h2 class="font-game text-2xl text-accent mb-4">ESCOLHA O SEU ARQUÉTIPO!</h2>
            <p class="text-primary mb-8">Ao atingir o Nível 10, você pode especializar-se. A sua classe dará bónus e missões únicas.</p>
            <div id="class-selection-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Class cards will be inserted here -->
            </div>
        </div>
    </div>

    <div id="mission-library-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-secondary border border-accent rounded-xl p-8 text-center max-w-lg w-full">
            <h2 class="font-game text-2xl text-accent mb-4">Biblioteca de Missões</h2>
            <div id="mission-library-list" class="h-64 overflow-y-auto space-y-2 text-left mb-6 pr-2">
                <!-- Library items will be inserted here -->
            </div>
            <button id="close-library-btn" class="font-semibold bg-yellow-500 text-gray-900 px-6 py-2 rounded-lg hover:bg-yellow-400 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-secondary rounded-lg p-6 max-w-sm w-full">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4">Tem a certeza?</h3>
            <p id="confirmation-message" class="text-sm text-secondary mb-6">Esta ação não pode ser revertida.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg bg-tertiary">Cancelar</button>
                <button id="confirm-accept-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Service Worker Registration
        /* if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        } */
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, writeBatch, runTransaction, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBuLs2bZ8-_8ci1Q4Nt4pYMZc1BplmDjOs",
            authDomain: "isk-ia.firebaseapp.com",
            projectId: "isk-ia",
            storageBucket: "isk-ia.appspot.com",
            messagingSenderId: "442504849543",
            appId: "1:442504849543:web:52c05c5aac9cb5a1e3b022",
            measurementId: "G-KMHL5D27FP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        function getInitialState() {
            return {
                level: 1, xp: 0, xpToNextLevel: 100, gold: 0,
                userId: null,
                playerClass: null,
                classMission: null,
                profilePicture: null,
                completionHistory: [],
                hero: { name: 'Herói do Cotidiano' },
                attributes: {
                    strength: { name: 'Força', icon: 'shield', xp: 0, level: 1, xpToNextLevel: 75, color: 'strength-bar', completedCount: 0 },
                    intelligence: { name: 'Inteligência', icon: 'brain', xp: 0, level: 1, xpToNextLevel: 75, color: 'intelligence-bar', completedCount: 0 },
                    charisma: { name: 'Carisma', icon: 'sparkles', xp: 0, level: 1, xpToNextLevel: 75, color: 'charisma-bar', completedCount: 0 },
                    vitality: { name: 'Vitalidade', icon: 'heart-pulse', xp: 0, level: 1, xpToNextLevel: 75, color: 'vitality-bar', completedCount: 0 },
                    creativity: { name: 'Criatividade', icon: 'wand-sparkles', xp: 0, level: 1, xpToNextLevel: 75, color: 'creativity-bar', completedCount: 0 },
                    wisdom: { name: 'Sabedoria', icon: 'book-open-check', xp: 0, level: 1, xpToNextLevel: 75, color: 'wisdom-bar', completedCount: 0 },
                    discipline: { name: 'Disciplina', icon: 'calendar-check-2', xp: 0, level: 1, xpToNextLevel: 75, color: 'discipline-bar', completedCount: 0 }
                },
                missions: { daily: [], weekly: [], monthly: [], bonus: [] },
                userMissionLibrary: [],
                titles: { unlocked: [], equipped: null },
                theme: 'futurista',
                timers: { 
                    lastDailyReset: null, customMissionsTodayCount: 0, swappedDaily: false,
                    lastWeeklyReset: null, customWeeklyThisWeek: 0, swappedWeekly: false,
                    lastMonthlyReset: null, customMonthlyThisMonth: 0, swappedMonthly: false,
                    lastBonusSpawnMonth: null, 
                    activeAbilityCooldowns: {}
                },
                boosts: {},
                chatHistory: [],
                offlineQueue: [], // Queue for offline actions
            };
        }
        let state = getInitialState();
        let hallOfFameState = {};

        const MISSION_POOLS = {
            daily: [
                { text: 'Ler 10 páginas de um livro', xp: 10, attribute: 'intelligence' },
                { text: 'Fazer uma caminhada de 20 minutos', xp: 12, attribute: 'strength' },
                { text: 'Elogiar sinceramente um colega ou amigo', xp: 8, attribute: 'charisma' },
                { text: 'Beber 2 litros de água', xp: 5, attribute: 'vitality' },
                { text: 'Meditar por 5 minutos', xp: 8, attribute: 'vitality' },
                { text: 'Organizar a sua secretária de trabalho', xp: 8, attribute: 'discipline' },
                { text: 'Escrever uma pequena ideia ou poema', xp: 10, attribute: 'creativity' },
                { text: 'Planear as tarefas de amanhã', xp: 8, attribute: 'wisdom' },
                { text: 'Fazer 10 minutos de alongamentos', xp: 10, attribute: 'strength' },
                { text: 'Resistir a uma tentação (ex: doce, procrastinação)', xp: 12, attribute: 'discipline' },
                { text: 'Enviar uma mensagem a um amigo com quem não fala há algum tempo', xp: 10, attribute: 'charisma' },
                { text: 'Aprender um atalho de teclado novo', xp: 5, attribute: 'intelligence' },
                { text: 'Ouvir um podcast sobre um tema novo', xp: 8, attribute: 'intelligence' },
                { text: 'Preparar um lanche saudável', xp: 8, attribute: 'vitality' },
                { text: 'Desenhar algo por 10 minutos', xp: 10, attribute: 'creativity' },
                { text: 'Identificar uma tarefa que tem vindo a adiar e dividi-la em 3 passos', xp: 12, attribute: 'wisdom' },
                { text: 'Praticar gratidão por 3 coisas', xp: 5, attribute: 'wisdom' },
                { text: 'Fazer 15 flexões ou agachamentos', xp: 10, attribute: 'strength' },
                { text: 'Iniciar uma conversa com um colega', xp: 8, attribute: 'charisma' },
                { text: 'Desligar as notificações do telemóvel por 1 hora', xp: 15, attribute: 'discipline' }
            ],
            weekly: [ 
                { text: 'Correr 10km ou fazer 3 sessões de exercício intenso', xp: 150, attribute: 'strength' },
                { text: 'Completar 3 capítulos de um curso online', xp: 120, attribute: 'intelligence' }, 
                { text: 'Marcar um café ou chamada com um amigo', xp: 70, attribute: 'charisma' },
                { text: 'Cozinhar 3 refeições saudáveis e novas', xp: 80, attribute: 'creativity' },
                { text: 'Manter uma rotina (matinal e noturna) por 7 dias', xp: 170, attribute: 'discipline'},
                { text: 'Refletir sobre os aprendizados e desafios da semana', xp: 75, attribute: 'wisdom' },
                { text: 'Experimentar um novo hobby por pelo menos 1 hora', xp: 100, attribute: 'creativity' },
                { text: 'Fazer uma "limpeza digital" (organizar ficheiros, emails)', xp: 90, attribute: 'discipline' },
                { text: 'Visitar um lugar novo na sua cidade (parque, café)', xp: 95, attribute: 'creativity' },
                { text: 'Dormir 7-8 horas por noite durante 5 dias', xp: 160, attribute: 'vitality' }
            ],
            monthly: [ 
                { text: 'Ler 1 livro longo (+300 pág) e resumir', xp: 300, attribute: 'intelligence' }, 
                { text: 'Aprender e aplicar uma nova habilidade (ex: básico de programação)', xp: 450, attribute: 'creativity' }, 
                { text: 'Melhorar um recorde pessoal de fitness em 10%', xp: 420, attribute: 'strength' }, 
                { text: 'Criar um plano de 3 meses para um objetivo de vida', xp: 370, attribute: 'wisdom' },
                { text: 'Manter um novo hábito por 21 dias seguidos', xp: 500, attribute: 'discipline'},
                { text: 'Fazer uma "detox" de redes sociais por 48 horas', xp: 250, attribute: 'discipline' },
                { text: 'Concluir um pequeno projeto pessoal do início ao fim', xp: 480, attribute: 'creativity' },
                { text: 'Fazer voluntariado por um dia', xp: 350, attribute: 'charisma' }
            ],
            bonus: [ 
                { text: 'Organizar uma atividade em grupo com amigos', description: 'Pode ser um jogo, um piquenique ou uma caminhada. O foco é na interação e na diversão em conjunto.', xp: 120, attribute: 'charisma' }, 
                { text: 'Visitar um museu ou galeria de arte', description: 'Explore a cultura local e inspire a sua criatividade. Observe as obras e tente interpretar o que o artista quis dizer.', xp: 100, attribute: 'creativity' }, 
                { text: 'Fazer uma surpresa positiva para um amigo', description: 'Prepare um lanche, envie uma mensagem de apoio inesperada ou ofereça ajuda com uma tarefa. O objetivo é o ato de generosidade para fortalecer laços.', xp: 150, attribute: 'charisma' },
                { text: 'Aprender a cozinhar um prato de uma cultura diferente', description: 'Pesquise uma receita, compre os ingredientes e aventure-se na cozinha. É uma ótima forma de expandir os seus horizontes culturais e criativos.', xp: 110, attribute: 'creativity' },
                { text: 'Escrever uma carta à mão para alguém importante', description: 'Num mundo digital, uma carta física tem um grande impacto. Expresse a sua gratidão ou partilhe uma memória.', xp: 140, attribute: 'charisma' }
            ]
        };
        
        const PERKS = {
            strength: { 
                5: { name: 'Vigor do Atleta', description: 'Desbloqueia Boosts de Força na Loja.' },
                10: { name: 'Potência Máxima', description: '+10% de XP em missões de Força.' },
                15: { name: 'Golpe Poderoso', description: 'A primeira missão de Força do dia vale o dobro de XP de atributo.' },
                20: { name: 'Resiliência de Ferro', description: 'Uma vez por semana, pode concluir instantaneamente uma missão de Força.'},
                25: { name: 'Titã Implacável', description: 'Desbloqueia uma missão mensal de Força única e de alta recompensa.' },
                30: { name: 'Ímpeto Incontrolável', description: 'Completar 3 missões de Força na semana concede um bónus de Ouro.' },
                35: { name: 'Fúria do Berserker', description: 'Ative para dobrar o ganho de XP e Ouro de missões de Força por 1 hora (1x por semana).'}
            },
            intelligence: { 
                5: { name: 'Mente Estratégica', description: '+10% de XP em missões de Inteligência.' },
                10: { name: 'Raciocínio Rápido', description: 'Reduz o custo em Ouro para trocar missões.' },
                15: { name: 'Polímata', description: 'Ganha um bónus de 5% de XP para todos os outros atributos ao completar uma missão de Inteligência.' },
                20: { name: 'Mente Brilhante', description: 'Análises da ISK IA tornam-se mais detalhadas e revelam "fraquezas" para focar.'},
                25: { name: 'Arquimago do Conhecimento', description: 'Desbloqueia uma "missão de pesquisa" semanal que recompensa com um grande bónus de XP em todos os atributos.'},
                30: { name: 'Conexão Neural', description: 'Reduz o tempo de recarga de habilidades ativas em 10%.' },
                35: { name: 'Singularidade', description: 'Uma vez por mês, pode transformar uma missão diária numa missão semanal, aumentando as suas recompensas.' }
            },
            charisma: {
                5: { name: 'Aura Cativante', description: '+10% de Ouro em todas as missões.' },
                10: { name: 'Elo Social', description: 'Desbloqueia interações especiais e presentes na Comunidade.' },
                15: { name: 'Líder Nato', description: 'Chance de receber uma "missão de grupo" bónus ao adicionar amigos.' },
                20: { name: 'Diplomacia', description: 'Melhora as recompensas de missões bónus.'},
                25: { name: 'Influência Lendária', description: 'Pode "inspirar" um amigo, dando-lhe um boost de XP de 10% por um dia (1x por semana).'},
                30: { name: 'Celebridade Local', description: 'Aumenta o Ouro ganho em missões de bónus em 25%.' },
                35: { name: 'Ídolo das Multidões', description: 'Completar uma missão de grupo (futura funcionalidade) tem chance de não gastar a sua "tentativa".' }
            },
            vitality: {
                5: { name: 'Robustez', description: '+5% de ganho de XP geral.' },
                10: { name: 'Recuperação Rápida', description: 'A primeira missão diária concluída a cada dia dá o dobro de XP.' },
                15: { name: 'Fonte de Vida', description: 'Desbloqueia uma missão semanal de "Bem-estar" única.' },
                20: { name: 'Imunidade', description: 'Oferece um "dia de descanso", permitindo manter a sequência de Disciplina mesmo sem completar missões.'},
                25: { name: 'Vontade Indomável', description: 'Uma vez por mês, pode recuperar uma missão semanal falhada.'},
                30: { name: 'Vigor Renovado', description: 'Ganha uma pequena quantidade de XP de Vitalidade passivamente todos os dias.' },
                35: { name: 'Fénix', description: 'Uma vez por mês, pode "reviver" e completar uma missão diária que falhou no dia anterior.' }
            },
            creativity: {
                5: { name: 'Inspiração Súbita', description: 'Chance de receber uma missão diária bónus.' },
                10: { name: 'Obra-prima', description: 'Missões criativas têm chance de "critar", dobrando o ouro ganho.' },
                15: { name: 'Mente Inovadora', description: 'Desbloqueia um espaço para uma "missão de projeto" mensal.' },
                20: { name: 'Visão Artística', description: 'Aumenta permanentemente o limite de missões personalizadas para 4 por dia.'},
                25: { name: 'Arquiteto de Sonhos', description: 'Desbloqueia a capacidade de criar "metas de longo prazo" com recompensas épicas personalizadas.'},
                30: { name: 'Eureka!', description: 'Chance de uma missão diária aleatória se transformar numa missão de Criatividade com recompensas bónus.' },
                35: { name: 'Legado do Artista', description: 'Permite arquivar uma "Obra-prima" (missão de projeto completa) num portfólio, concedendo um bónus passivo de Ouro.' }
            },
            wisdom: {
                5: { name: 'Visão Clara', description: 'Permite trocar uma missão diária por dia gratuitamente.' },
                10: { name: 'Planeamento Mestre', description: 'Bónus de XP por completar todas as missões diárias antes do meio-dia.' },
                15: { name: 'Sábio Ancião', description: 'Permite trocar uma missão semanal por semana gratuitamente.' },
                20: { name: 'Precognição', description: 'Permite ver as missões diárias do dia seguinte.'},
                25: { name: 'Mestre Zen', description: 'Uma vez por mês, pode "meditar" para receber um bónus de 25% de XP em todas as missões por 24 horas.'},
                30: { name: 'Intuição Aguçada', description: 'A primeira troca de missão do dia tem 50% de chance de não contar para o limite.' },
                35: { name: 'Oráculo', description: 'Permite ver o atributo da missão bónus antes de ela aparecer.' }
            },
            discipline: {
                5: { name: 'Foco Inabalável', description: 'Reduz o custo em Ouro dos itens da Loja em 10%.' },
                10: { name: 'Sequência Perfeita', description: 'Bónus de XP por completar todas as missões diárias 3 dias seguidos.' },
                15: { name: 'Hábito de Ferro', description: 'A primeira missão de Disciplina do dia vale o dobro de XP de atributo.' },
                20: { name: 'Hábito Mestre', description: 'A sua sequência de Disciplina agora recompensa com Ouro a cada 7 dias.'},
                25: { name: 'Vontade de Titânio', description: 'Nunca perde a sua sequência de Disciplina por falhar um único dia (tem uma "vida extra" por semana).'},
                30: { name: 'Autocontrolo de Aço', description: 'Aumenta a quantidade de Ouro ganha pelo perk "Hábito Mestre".' },
                35: { name: 'Virtuoso', description: 'Manter uma sequência de 30 dias de Disciplina concede uma recompensa massiva de XP e Ouro.' }
            }
        };

        const CLASS_PERKS = {
             sabio: {
                10: { name: 'Habilidade Ativa: Foco de Mestre', description: 'Dobre o ganho de XP de Inteligência e Sabedoria por 1 hora (1x por dia).' },
                15: { name: 'Perk Passivo: Biblioteca Pessoal', description: 'Desbloqueia uma missão de classe mensal de "Leitura Profunda", com recompensas massivas.' },
                20: { name: 'Habilidade Ativa: Eureca!', description: 'Receba instantaneamente a solução para um "puzzle" ou um grande bónus de XP para uma missão de pesquisa.' },
                25: { name: 'Perk Passivo: Conhecimento Universal', description: 'Todas as missões, independentemente do atributo, têm uma pequena chance de conceder XP de Inteligência.'},
                30: { name: 'Habilidade Suprema: Omnisciência', description: 'Por 10 minutos, todas as missões concluídas concedem XP de Inteligência bónus (1x por semana).'}
            },
             atleta: {
                10: { name: 'Habilidade Ativa: Adrenalina', description: 'Dobre o ganho de XP de Força e Vitalidade por 1 hora (1x por dia).' },
                15: { name: 'Perk Passivo: Corpo de Aço', description: 'Reduz a "penalidade" por falhar missões físicas (futura funcionalidade).' },
                20: { name: 'Habilidade Ativa: Segundo Fôlego', description: 'Recupere uma "vida extra" para a sequência de Disciplina (1x por semana).' },
                25: { name: 'Perk Passivo: Pico de Performance', description: 'Completar a missão de classe semanal concede um bónus de XP geral de 10% por 24 horas.'},
                30: { name: 'Habilidade Suprema: Super Sayan', description: 'Por 10 minutos, o custo de energia para todas as ações é reduzido a zero (1x por semana).'}
            },
            artista: {
                10: { name: 'Habilidade Ativa: Inspiração Divina', description: 'Dobre o ganho de XP de Criatividade e Carisma por 1 hora (1x por dia).' },
                15: { name: 'Perk Passivo: Obra de Arte', description: 'Missões de classe têm chance de render o dobro de Ouro.' },
                20: { name: 'Habilidade Ativa: Palco do Mundo', description: 'Receba uma missão bónus de Carisma com recompensas elevadas (1x por semana).' },
                25: { name: 'Perk Passivo: Legado Criativo', description: 'Missões de projeto concedem um bónus permanente de Ouro passivo após a conclusão.'},
                30: { name: 'Habilidade Suprema: Toque de Midas', description: 'A próxima missão concluída concede o triplo de Ouro (1x por semana).'}
            },
            estrategista: {
                10: { name: 'Habilidade Ativa: Estado de Fluxo', description: 'Dobre o ganho de XP de Disciplina e Sabedoria por 1 hora (1x por dia).' },
                15: { name: 'Perk Passivo: Planeamento Eficiente', description: 'Reduz o custo para trocar missões mensais.' },
                20: { name: 'Habilidade Ativa: Xeque-mate', description: 'Conclua instantaneamente uma missão de Sabedoria ou Disciplina (1x por semana).' },
                25: { name: 'Perk Passivo: Mestre Tático', description: 'A primeira troca de missão de qualquer modalidade a cada semana é sempre gratuita.'},
                30: { name: 'Habilidade Suprema: A Arte da Guerra', description: 'Todas as trocas de missões são gratuitas por 24 horas (1x por semana).'}
            }
        };


        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const coachSystemPrompt = "Você é 'ISK', uma IA assistente de vida. Seja direto, conciso e estratégico. Seu objetivo é ajudar o usuário a melhorar. Dê conselhos práticos e análises resumidas. Para sugerir uma missão, use o formato 'MISSAO::[Título Curto]::[atributo]::[modalidade (daily, weekly, monthly)]'. Nunca use o formato PERGUNTA. Responda em português.";
        const DOMElements = {
            levelDisplay: document.getElementById('level-display'), xpBar: document.getElementById('xp-bar'), xpText: document.getElementById('xp-text'), goldDisplay: document.getElementById('gold-display'), avgTimeDisplay: document.getElementById('avg-time-display'), attributesList: document.getElementById('attributes-list'), heroNameDisplay: document.getElementById('hero-name-display'),
            profilePictureContainer: document.getElementById('profile-picture-container'), profilePictureImg: document.getElementById('profile-picture-img'), profilePictureIcon: document.getElementById('profile-picture-icon'), profilePictureInput: document.getElementById('profile-picture-input'),
            tabs: document.querySelectorAll('.tab-btn'), tabContents: document.querySelectorAll('.tab-content'),
            
            addDailyMissionForm: document.getElementById('add-daily-mission-form'), newDailyMissionText: document.getElementById('new-daily-mission-text'), newDailyMissionAttribute: document.getElementById('new-daily-mission-attribute'), addDailyMissionBtn: document.getElementById('add-daily-mission-btn'), addDailyMissionBtnText: document.getElementById('add-daily-mission-btn-text'),
            addWeeklyMissionForm: document.getElementById('add-weekly-mission-form'), newWeeklyMissionText: document.getElementById('new-weekly-mission-text'), newWeeklyMissionAttribute: document.getElementById('new-weekly-mission-attribute'), addWeeklyMissionBtn: document.getElementById('add-weekly-mission-btn'), addWeeklyMissionBtnText: document.getElementById('add-weekly-mission-btn-text'),
            addMonthlyMissionForm: document.getElementById('add-monthly-mission-form'), newMonthlyMissionText: document.getElementById('new-monthly-mission-text'), newMonthlyMissionAttribute: document.getElementById('new-monthly-mission-attribute'), addMonthlyMissionBtn: document.getElementById('add-monthly-mission-btn'), addMonthlyMissionBtnText: document.getElementById('add-monthly-mission-btn-text'),

            dailyTaskList: document.getElementById('daily-task-list'), weeklyTaskList: document.getElementById('weekly-task-list'), monthlyTaskList: document.getElementById('monthly-task-list'), bonusTaskList: document.getElementById('bonus-task-list'), bonusMissionContainer: document.getElementById('bonus-mission-container'),
            dailyCountdown: document.getElementById('daily-countdown'), weeklyCountdown: document.getElementById('weekly-countdown'), monthlyCountdown: document.getElementById('monthly-countdown'),
            dailySwapCounter: document.getElementById('daily-swap-counter'), weeklySwapCounter: document.getElementById('weekly-swap-counter'), monthlySwapCounter: document.getElementById('monthly-swap-counter'),
            heroNameInput: document.getElementById('hero-name-input'), progressCharts: document.getElementById('progress-charts'), analyzeProgressBtn: document.getElementById('analyze-progress-btn'), analyzeIcon: document.getElementById('analyze-icon'), analyzeSpinner: document.getElementById('analyze-spinner'), progressAnalysisBox: document.getElementById('progress-analysis-box'),
            aiChatbox: document.getElementById('ai-chatbox'), aiInput: document.getElementById('ai-input'), aiSendBtn: document.getElementById('ai-send-btn'), sendIcon: document.getElementById('send-icon'), loadingSpinner: document.getElementById('loading-spinner'),
            levelUpModal: document.getElementById('level-up-modal'), levelUpCard: document.getElementById('level-up-card'), newLevelText: document.getElementById('new-level-text'), closeModalBtn: document.getElementById('close-modal-btn'),
            classSelectionModal: document.getElementById('class-selection-modal'), classSelectionContainer: document.getElementById('class-selection-container'), classDisplay: document.getElementById('class-display'), classMissionContainer: document.getElementById('class-mission-container'), classTaskList: document.getElementById('class-task-list'),
            communityListView: document.getElementById('community-list-view'), communityChatView: document.getElementById('community-chat-view'), backToCommunitiesBtn: document.getElementById('back-to-communities-btn'), communityChatTitle: document.getElementById('community-chat-title'), communityChatBox: document.getElementById('community-chat-box'), communityList: document.getElementById('community-list'), userIdDisplay: document.getElementById('user-id-display'),
            communityChatInput: document.getElementById('community-chat-input'), communityChatSendBtn: document.getElementById('community-chat-send-btn'),
            perksList: document.getElementById('perks-list'),
            classPerksContainer: document.getElementById('class-perks-container'), classPerksTitle: document.getElementById('class-perks-title'), classPerksList: document.getElementById('class-perks-list'),
            missionLibraryModal: document.getElementById('mission-library-modal'),
            missionLibraryList: document.getElementById('mission-library-list'),
            closeLibraryBtn: document.getElementById('close-library-btn'),
            authButtons: document.getElementById('auth-buttons'),
            logoutSection: document.getElementById('logout-section'),
            userEmail: document.getElementById('user-email'),
            googleLoginBtn: document.getElementById('google-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            themeSelector: document.getElementById('theme-selector'),
            heroTitleDisplay: document.getElementById('hero-title-display'),
            titlesContainer: document.getElementById('titles-container'),
            titlesList: document.getElementById('titles-list'),
            hallOfFameContainer: document.getElementById('hall-of-fame-container'),
            hallOfFameList: document.getElementById('hall-of-fame-list'),
            resetAccountBtn: document.getElementById('reset-account-btn'),
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmAcceptBtn: document.getElementById('confirm-accept-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            confirmationTitle: document.getElementById('confirmation-title'),
            confirmationMessage: document.getElementById('confirmation-message'),
            toggleCreateMissionBtn: document.getElementById('toggle-create-mission-btn'),
            createMissionContent: document.getElementById('create-mission-content'),
            createMissionChevron: document.getElementById('create-mission-chevron'),
        };

        const CLASSES = {
            sabio: { name: 'Sábio', focus: ['intelligence', 'wisdom'], missionPool: [ { text: 'Assistir a um documentário e resumir', xp: 200, attribute: 'intelligence' } ]},
            atleta: { name: 'Atleta', focus: ['strength', 'vitality'], missionPool: [ { text: 'Tentar um novo tipo de exercício', xp: 250, attribute: 'strength' } ] },
            artista: { name: 'Artista', focus: ['creativity', 'charisma'], missionPool: [ { text: 'Dedicar 2 horas a um projeto criativo', xp: 220, attribute: 'creativity' } ] },
            estrategista: { name: 'Estrategista', focus: ['discipline', 'wisdom'], missionPool: [ { text: 'Aplicar uma nova técnica de produtividade', xp: 280, attribute: 'discipline' } ] },
        };

        function renderAll() {
            renderCharacterSheet();
            renderMissions();
            renderProgress();
            renderCommunityTab();
            renderAddMissionForms();
            renderPerks();
            renderSwapCounters();
            lucide.createIcons();

        // Evitar reload nos formulários de criar missão
        [DOMElements.addDailyMissionForm, DOMElements.addWeeklyMissionForm, DOMElements.addMonthlyMissionForm].forEach(form => {
            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                });
            }
        });

        }

        function renderCharacterSheet() {
            DOMElements.heroNameDisplay.innerText = state.hero.name;
            DOMElements.levelDisplay.innerText = `LVL ${state.level}`;
            DOMElements.xpBar.style.width = `${(state.xp / state.xpToNextLevel) * 100}%`;
            DOMElements.xpText.innerText = `${state.xp} / ${state.xpToNextLevel}`;
            DOMElements.goldDisplay.innerText = state.gold;
            DOMElements.heroTitleDisplay.textContent = state.titles.equipped || '';

            if (state.playerClass) {
                DOMElements.classDisplay.textContent = CLASSES[state.playerClass].name;
            } else {
                DOMElements.classDisplay.textContent = '';
            }

            if (state.profilePicture) {
                DOMElements.profilePictureImg.src = state.profilePicture;
                DOMElements.profilePictureImg.classList.remove('hidden');
                DOMElements.profilePictureIcon.classList.add('hidden');
            } else {
                DOMElements.profilePictureImg.classList.add('hidden');
                DOMElements.profilePictureIcon.classList.remove('hidden');
            }

            DOMElements.attributesList.innerHTML = '';
            for (const key in state.attributes) {
                const attr = state.attributes[key];
                const attrEl = document.createElement('div');
                const xpPercentage = (attr.xp / attr.xpToNextLevel) * 100;
                
                let nextPerkTitle = 'Nível Máximo Atingido';
                if (PERKS[key]) {
                    const nextPerkLevel = Object.keys(PERKS[key]).map(Number).find(level => level > attr.level);
                    if (nextPerkLevel) {
                        nextPerkTitle = `Próximo Perk: ${PERKS[key][nextPerkLevel].name} (Nv. ${nextPerkLevel})`;
                    }
                }

                attrEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2"><i class="lucide-icon w-4 h-4" data-lucide="${attr.icon}"></i><span class="font-semibold text-sm">${attr.name}</span></div>
                        <span class="text-xs font-bold">Lvl ${attr.level}</span>
                    </div>
                    <div class="w-full bg-tertiary h-2.5 attribute-bar">
                        <div class="h-2.5 rounded-full attribute-bar-inner ${attr.color}" style="width: ${xpPercentage}%"></div>
                    </div>
                    <p class="next-perk">${nextPerkTitle}</p>
                    `;
                DOMElements.attributesList.appendChild(attrEl);
            }
        }
        
        function createMissionElement(mission, type) {
            const missionEl = document.createElement('div');
            missionEl.className = `p-4 rounded-lg transition-all ${mission.completed ? 'bg-tertiary/50 text-secondary' : 'bg-secondary hover:bg-tertiary/70'}`;
            const attribute = state.attributes[mission.attribute];
            const completionTime = mission.completionTimestamp ? new Date(mission.completionTimestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            
            const timerKey = `swapped${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const canSwap = !state.timers[timerKey];

            const isWisdomPerkActive = (type === 'daily' && state.attributes.wisdom.level >= 5) || (type === 'weekly' && state.attributes.wisdom.level >= 15);
            let swapButtonHtml = '';
            if (!mission.completed && !mission.userCreated && (canSwap || isWisdomPerkActive)) {
                 const title = isWisdomPerkActive ? 'Troca Grátis (Perk Sabedoria)' : 'Trocar Missão';
                 const classes = isWisdomPerkActive ? 'bg-teal-600 hover:bg-teal-500' : 'bg-blue-600 hover:bg-blue-500';
                 swapButtonHtml = `<button class="swap-btn ${classes} text-white font-bold p-2 rounded-lg" title="${title}" data-mission-id="${mission.id}" data-mission-type="${type}"><i class="lucide-icon w-4 h-4" data-lucide="repeat"></i></button>`;
            }

            missionEl.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start flex-grow">
                         <i class="lucide-icon mr-3 mt-1 ${mission.completed ? 'text-green-500' : 'text-accent'}" data-lucide="${mission.completed ? 'check-circle-2' : 'circle'}"></i>
                        <div class="pr-2">
                            <span class="${mission.completed ? 'line-through' : ''}">${mission.text}</span>
                            ${mission.description ? `<div class="mission-description">${mission.description}</div>` : ''}
                            <div class="flex items-center text-xs text-secondary mt-1">
                                <i class="lucide-icon w-3 h-3 mr-1" data-lucide="${attribute.icon}"></i>
                                <span>+${mission.xp} XP ${attribute.name}</span>
                                ${completionTime ? `<span class="ml-2 flex items-center gap-1"><i class="lucide-icon w-3 h-3" data-lucide="clock"></i>${completionTime}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3 ml-2 flex-shrink-0">
                        <span class="font-semibold text-yellow-400 text-sm flex items-center gap-1">
                            <i class="lucide-icon w-4 h-4" data-lucide="coins"></i> ${Math.floor(mission.xp / 2)}
                        </span>
                        ${swapButtonHtml}
                        ${!mission.completed ? `<button class="complete-btn bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-1.5 text-sm transition-transform hover:scale-105" data-mission-id="${mission.id}" data-mission-type="${type}">Concluir <i class="lucide-icon w-4 h-4" data-lucide="check-circle"></i></button>` : ''}
                    </div>
                </div>`;
            return missionEl;
        }

        function renderMissions() {
            if (state.classMission) {
                DOMElements.classMissionContainer.classList.remove('hidden');
                DOMElements.classTaskList.innerHTML = '';
                DOMElements.classTaskList.appendChild(createMissionElement(state.classMission, 'class'));
            } else {
                DOMElements.classMissionContainer.classList.add('hidden');
            }

            const lists = { daily: DOMElements.dailyTaskList, weekly: DOMElements.weeklyTaskList, monthly: DOMElements.monthlyTaskList, bonus: DOMElements.bonusTaskList };
            for (const type in lists) {
                lists[type].innerHTML = '';
                if (state.missions[type] && state.missions[type].length > 0) {
                    state.missions[type].forEach(mission => { lists[type].appendChild(createMissionElement(mission, type)); });
                } else {
                    if (type !== 'bonus') lists[type].innerHTML = `<p class="text-secondary text-center italic">Nenhuma missão por enquanto.</p>`;
                }
            }
            DOMElements.bonusMissionContainer.style.display = state.missions.bonus.length > 0 ? 'block' : 'none';
        }

        function renderProgress() {
            const { progressCharts } = DOMElements;
            progressCharts.innerHTML = '';
            const totalCompleted = Object.values(state.attributes).reduce((sum, attr) => sum + attr.completedCount, 0);
            if (totalCompleted === 0) {
                progressCharts.innerHTML = '<p class="text-secondary text-center italic">Complete missões para ver as suas estatísticas.</p>';
                return;
            }
            for (const key in state.attributes) {
                const attr = state.attributes[key];
                const percentage = totalCompleted > 0 ? (attr.completedCount / totalCompleted) * 100 : 0;
                const chartEl = document.createElement('div');
                chartEl.innerHTML = `
                    <div class="flex items-center gap-2 mb-1"> <i class="lucide-icon w-4 h-4" data-lucide="${attr.icon}"></i> <span class="font-semibold text-sm">${attr.name} (${attr.completedCount} missões)</span> </div>
                    <div class="w-full bg-tertiary rounded-full h-4 attribute-bar"> <div class="h-4 rounded-full text-xs text-white text-center font-bold flex items-center justify-center ${attr.color}" style="width: ${percentage}%">${Math.round(percentage)}%</div> </div>`;
                progressCharts.appendChild(chartEl);
            }
        }

        function renderCommunityTab() {
            DOMElements.userIdDisplay.textContent = state.userId;
        }

        function renderAddMissionForms() {
            const dailyLimit = 3, weeklyLimit = 1, monthlyLimit = 1;
            const dailyCount = state.timers.customMissionsTodayCount;
            const weeklyCount = state.timers.customWeeklyThisWeek;
            const monthlyCount = state.timers.customMonthlyThisMonth;

            // Daily
            if (dailyCount >= dailyLimit) {
                DOMElements.addDailyMissionBtn.disabled = true;
                DOMElements.newDailyMissionText.disabled = true;
                DOMElements.addDailyMissionBtnText.textContent = `Limite atingido (${dailyCount}/${dailyLimit})`;
            } else {
                DOMElements.addDailyMissionBtn.disabled = false;
                 DOMElements.newDailyMissionText.disabled = false;
                DOMElements.addDailyMissionBtnText.textContent = `Adicionar Missão (${dailyCount}/${dailyLimit})`;
            }
            // Weekly
            if (weeklyCount >= weeklyLimit) {
                DOMElements.addWeeklyMissionBtn.disabled = true;
                DOMElements.newWeeklyMissionText.disabled = true;
                DOMElements.addWeeklyMissionBtnText.textContent = `Limite atingido (${weeklyCount}/${weeklyLimit})`;
            } else {
                DOMElements.addWeeklyMissionBtn.disabled = false;
                 DOMElements.newWeeklyMissionText.disabled = false;
                DOMElements.addWeeklyMissionBtnText.textContent = `Adicionar Missão (${weeklyCount}/${weeklyLimit})`;
            }
             // Monthly
            if (monthlyCount >= monthlyLimit) {
                DOMElements.addMonthlyMissionBtn.disabled = true;
                 DOMElements.newMonthlyMissionText.disabled = true;
                DOMElements.addMonthlyMissionBtnText.textContent = `Limite atingido (${monthlyCount}/${monthlyLimit})`;
            } else {
                DOMElements.addMonthlyMissionBtn.disabled = false;
                 DOMElements.newMonthlyMissionText.disabled = false;
                DOMElements.addMonthlyMissionBtnText.textContent = `Adicionar Missão (${monthlyCount}/${monthlyLimit})`;
            }
        }

        function renderPerks() {
            DOMElements.perksList.innerHTML = '';
            let unlockedCount = 0;
            for(const attrKey in PERKS) {
                const attrPerks = PERKS[attrKey];
                const userAttrLevel = state.attributes[attrKey].level;
                for(const levelReq in attrPerks) {
                    if (userAttrLevel >= parseInt(levelReq)) {
                        unlockedCount++;
                        const perk = attrPerks[levelReq];
                        const perkEl = document.createElement('div');
                        perkEl.className = 'bg-tertiary/50 p-4 rounded-lg flex items-start gap-3';
                        perkEl.innerHTML = `
                            <i class="lucide-icon text-yellow-400 mt-1" data-lucide="star"></i>
                            <div>
                                <h3 class="font-semibold">${perk.name} <span class="text-xs text-secondary font-normal">(Nível ${levelReq} ${state.attributes[attrKey].name})</span></h3>
                                <p class="text-xs text-secondary">${perk.description}</p>
                            </div>
                        `;
                        DOMElements.perksList.appendChild(perkEl);
                    }
                }
            }
            if (unlockedCount === 0) {
                 DOMElements.perksList.innerHTML = '<p class="text-secondary text-center italic">Aumente o nível dos seus atributos para desbloquear perks!</p>';
            }
            renderClassPerks();
        }

        function renderClassPerks() {
            if (state.playerClass) {
                DOMElements.classPerksContainer.classList.remove('hidden');
                DOMElements.classPerksTitle.innerHTML = `<i class="lucide-icon" data-lucide="swords"></i> Perks de ${CLASSES[state.playerClass].name}`;
                DOMElements.classPerksList.innerHTML = '';
                let unlockedClassPerks = 0;
                const classPerks = CLASS_PERKS[state.playerClass];
                for(const levelReq in classPerks) {
                    if (state.level >= parseInt(levelReq)) {
                        unlockedClassPerks++;
                        const perk = classPerks[levelReq];
                        const perkEl = document.createElement('div');
                        perkEl.className = 'bg-tertiary/50 p-4 rounded-lg flex items-start gap-3';
                        let buttonHtml = '';
                        if (perk.name.includes('Habilidade Ativa')) {
                            const abilityKey = `${state.playerClass}-${levelReq}`;
                            const cooldownEnd = state.timers.activeAbilityCooldowns[abilityKey];
                            const now = Date.now();
                             if (cooldownEnd && now < cooldownEnd) {
                                buttonHtml = `<button class="w-full mt-2 bg-tertiary text-primary font-bold py-2 px-4 rounded-lg cursor-not-allowed text-sm" disabled>Em Recarga (${formatCountdown(cooldownEnd - now)})</button>`;
                            } else {
                                buttonHtml = `<button class="activate-ability-btn w-full mt-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm" data-ability-key="${abilityKey}">Ativar</button>`;
                            }
                        }

                        perkEl.innerHTML = `
                            <i class="lucide-icon text-accent mt-1" data-lucide="sparkles"></i>
                            <div>
                                <h3 class="font-semibold">${perk.name} <span class="text-xs text-secondary font-normal">(Nível de Herói ${levelReq})</span></h3>
                                <p class="text-xs text-secondary">${perk.description}</p>
                                ${buttonHtml}
                            </div>
                        `;
                        DOMElements.classPerksList.appendChild(perkEl);
                    }
                }
                if (unlockedClassPerks === 0) {
                     DOMElements.classPerksList.innerHTML = '<p class="text-secondary text-center italic">Suba de nível para desbloquear perks de classe!</p>';
                }

            } else {
                DOMElements.classPerksContainer.classList.add('hidden');
            }
        }

        function renderSwapCounters() {
            DOMElements.dailySwapCounter.textContent = `Troca: ${state.timers.swappedDaily ? 0 : 1}/1`;
            DOMElements.weeklySwapCounter.textContent = `Troca: ${state.timers.swappedWeekly ? 0 : 1}/1`;
            DOMElements.monthlySwapCounter.textContent = `Troca: ${state.timers.swappedMonthly ? 0 : 1}/1`;
        }
        
        function gainXp(amount) {
            state.xp += amount;
            while (state.xp >= state.xpToNextLevel) {
                const oldLevel = state.level;
                state.level++;
                state.xp -= state.xpToNextLevel;
                state.xpToNextLevel = Math.floor(state.xpToNextLevel * 1.2 + 50);
                if (state.level === 10 && !state.playerClass) {
                    showClassSelectionModal();
                } else {
                    showLevelUpModal(oldLevel);
                }
            }
        }
        
        function gainAttributeXp(attributeKey, amount) {
            const attr = state.attributes[attributeKey];
            if (!attr) return;
            
            // Apply class passive bonus
            if (state.playerClass && CLASSES[state.playerClass].focus.includes(attributeKey)) {
                amount = Math.floor(amount * 1.15);
            }

            // Apply active ability boosts
            for (const boostKey in state.boosts) {
                if (Date.now() < state.boosts[boostKey]) {
                    const [classKey, levelReq] = boostKey.split('-');
                    // Foco de Mestre (Sábio)
                    if (boostKey === 'sabio-10' && (attributeKey === 'intelligence' || attributeKey === 'wisdom')) amount *= 2;
                    // Adrenalina (Atleta)
                    if (boostKey === 'atleta-10' && (attributeKey === 'strength' || attributeKey === 'vitality')) amount *= 2;
                    // Inspiração Divina (Artista)
                    if (boostKey === 'artista-10' && (attributeKey === 'creativity' || attributeKey === 'charisma')) amount *= 2;
                    // Estado de Fluxo (Estrategista)
                    if (boostKey === 'estrategista-10' && (attributeKey === 'discipline' || attributeKey === 'wisdom')) amount *= 2;
                }
            }

            attr.xp += amount;
            while(attr.xp >= attr.xpToNextLevel) {
                const oldAttrLevel = attr.level;
                attr.level++;
                attr.xp -= attr.xpToNextLevel;
                attr.xpToNextLevel = Math.floor(attr.xpToNextLevel * 1.25 + 100);
                if (attr.level >= 35 && oldAttrLevel < 35) {
                    claimHallOfFame(attributeKey);
                }
            }
            renderPerks();
        }

        function completeTask(missionId, missionType) {
            let mission;
            if (missionType === 'class') {
                mission = state.classMission;
            } else {
                mission = state.missions[missionType].find(m => m.id === missionId);
            }

            if (mission && !mission.completed) {
                mission.completed = true; 
                mission.completionTimestamp = Date.now();
                
                if (missionType !== 'class') {
                    state.completionHistory.push(mission.completionTimestamp);
                    state.attributes[mission.attribute].completedCount++;
                }

                gainXp(mission.xp);
                gainAttributeXp(mission.attribute, mission.xp);
                state.gold += Math.floor(mission.xp / 2);
                
                if(!navigator.onLine) {
                    state.offlineQueue.push({missionId, missionType, timestamp: mission.completionTimestamp});
                }

                renderAll(); 
                saveState(state.userId);
            }
        }

        function showLevelUpModal(oldLevel) {
            DOMElements.newLevelText.innerText = `Nível ${state.level}`;
            DOMElements.levelUpModal.classList.remove('hidden');
            setTimeout(() => {
                DOMElements.levelUpCard.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            DOMElements.levelUpCard.classList.remove('scale-100');
            setTimeout(() => {
                DOMElements.levelUpModal.classList.add('hidden');
                DOMElements.classSelectionModal.classList.add('hidden');
            }, 300);
        }

        function getPseudoRandomBonusDay(year, month) {
            const seed = year * 100 + month; let hash = 0;
            const strSeed = seed.toString();
            for (let i = 0; i < strSeed.length; i++) { hash = (hash << 5) - hash + strSeed.charCodeAt(i); hash |= 0; }
            return (Math.abs(hash) % 16) + 10;
        }

        function checkAndGenerateMissions() {
            const now = new Date(); const today = now.toISOString().split('T')[0];
            const currentWeek = getWeekNumber(now); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
            let missionsUpdated = false;
            
            if (state.timers.lastDailyReset !== today) { 
                state.missions.daily = generateMissions(MISSION_POOLS.daily, 3); 
                state.timers.lastDailyReset = today; 
                state.timers.customMissionsTodayCount = 0;
                state.timers.swappedDaily = false;
                missionsUpdated = true; 
            }
            if (state.timers.lastWeeklyReset !== `${currentYear}-${currentWeek}`) { 
                state.missions.weekly = generateMissions(MISSION_POOLS.weekly, 2); 
                if (state.playerClass) {
                    generateClassMission();
                }
                state.timers.lastWeeklyReset = `${currentYear}-${currentWeek}`; 
                state.timers.customWeeklyThisWeek = 0;
                state.timers.swappedWeekly = false;
                missionsUpdated = true; 
            }
            if (state.timers.lastMonthlyReset !== `${currentYear}-${currentMonth}`) { 
                state.missions.monthly = generateMissions(MISSION_POOLS.monthly, 2); 
                state.timers.lastMonthlyReset = `${currentYear}-${currentMonth}`;
                state.timers.customMonthlyThisMonth = 0;
                state.timers.swappedMonthly = false;
                missionsUpdated = true;
            }
            const bonusDay = getPseudoRandomBonusDay(currentYear, currentMonth);
            if (now.getDate() === bonusDay && state.timers.lastBonusSpawnMonth !== `${currentYear}-${currentMonth}`) { state.missions.bonus = generateMissions(MISSION_POOLS.bonus, 1); state.timers.lastBonusSpawnMonth = `${currentYear}-${currentMonth}`; missionsUpdated = true;
            } else if (now.getDate() !== bonusDay && state.missions.bonus.length > 0) { state.missions.bonus = []; missionsUpdated = true; }
            if (missionsUpdated) { renderAll(); saveState(state.userId); }
        }
        
        function generateMissions(pool, count) {
            const shuffled = [...pool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map(m => ({ ...m, id: crypto.randomUUID(), completed: false, completionTimestamp: null }));
        }

        function generateClassMission() {
            if (!state.playerClass) return;
            const classInfo = CLASSES[state.playerClass];
            const missionData = classInfo.missionPool[Math.floor(Math.random() * classInfo.missionPool.length)];
            state.classMission = { ...missionData, id: `class-${crypto.randomUUID()}`, completed: false, completionTimestamp: null, type: 'class' };
        }

        function updateCountdowns() {
            const now = new Date();
            const endOfDay = new Date(now); endOfDay.setHours(23, 59, 59, 999);
            DOMElements.dailyCountdown.textContent = `Reinicia em: ${formatCountdown(endOfDay - now)}`;
            const endOfWeek = new Date(now); const day = endOfWeek.getDay(); const diff = endOfWeek.getDate() - day + (day === 0 ? -6 : 1) + 6; endOfWeek.setDate(diff); endOfWeek.setHours(23, 59, 59, 999);
            DOMElements.weeklyCountdown.textContent = `Reinicia em: ${formatCountdown(endOfWeek - now)}`;
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            DOMElements.monthlyCountdown.textContent = `Reinicia em: ${formatCountdown(endOfMonth - now)}`;
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatCountdown(ms) {
            if (ms < 0) return '00:00:00';
            let seconds = Math.floor(ms / 1000); let minutes = Math.floor(seconds / 60); let hours = Math.floor(minutes / 60); let days = Math.floor(hours / 24);
            hours %= 24; minutes %= 60; seconds %= 60;
            if (days > 0) return `${days}d ${String(hours).padStart(2, '0')}h`;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function addMessageToChat(message, sender, special = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender === 'user' ? 'user' : 'other'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-3 rounded-2xl w-fit ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            
            let content = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            if(special?.type === 'mission') {
                 content += `<br><button class="add-mission-btn mt-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-1 px-3 rounded-lg text-sm" data-text="${special.data.text}" data-attribute="${special.data.attribute}" data-modality="${special.data.modality}">Adicionar Missão</button>`;
            }
            bubble.innerHTML = content;
            messageWrapper.appendChild(bubble);
            DOMElements.aiChatbox.appendChild(messageWrapper);
            DOMElements.aiChatbox.scrollTop = DOMElements.aiChatbox.scrollHeight;
        }
        
        function setLoading(isLoading, element) {
            if(DOMElements[element + 'Btn']) DOMElements[element + 'Btn'].disabled = isLoading;
            if(DOMElements[element + 'Icon']) DOMElements[element + 'Icon'].classList.toggle('hidden', isLoading);
            if(DOMElements[element + 'Spinner']) DOMElements[element + 'Spinner'].classList.toggle('hidden', !isLoading);
        }
        
        async function callGeminiAPI(prompt, systemPrompt = coachSystemPrompt) {
             if (!navigator.onLine) {
                return "Parece que você está offline. As funcionalidades da ISK IA precisam de uma ligação à internet.";
            }
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                return null;
            }
        }
        
        async function handleAISubmit() {
            const userInput = DOMElements.aiInput.value.trim(); if (!userInput) return;
            addMessageToChat(userInput, 'user'); DOMElements.aiInput.value = ''; setLoading(true, 'aiSend');
            try {
                const aiResponse = await callGeminiAPI(userInput);
                if (aiResponse) {
                    state.chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                    const missionMatch = aiResponse.match(/MISSAO::(.*?)::(.*?)::(daily|weekly|monthly)/);
                    if (missionMatch) { 
                        const [, text, attribute, modality] = missionMatch; 
                        const cleanResponse = aiResponse.replace(missionMatch[0], '').trim(); 
                        addMessageToChat(cleanResponse, 'ai', {type: 'mission', data: {text, attribute, modality}});
                    } else { 
                        addMessageToChat(aiResponse, 'ai'); 
                    }
                    state.chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                } else { addMessageToChat('Desculpe, não consegui processar a sua resposta. Tente novamente.', 'ai'); }
            } catch (error) {
                 addMessageToChat('Ocorreu um erro ao conectar com a ISK IA.', 'ai');
            } finally { setLoading(false, 'aiSend'); saveState(state.userId); }
        }
        
        async function handleProgressAnalysis() {
            setLoading(true, 'analyzeProgress'); 
            DOMElements.progressAnalysisBox.innerHTML = 'Analisando o seu progresso...';
            const progressSummary = `Análise de progresso para ${state.hero.name}: Nível geral ${state.level}. Atributos: Força Lvl ${state.attributes.strength.level}, Inteligência Lvl ${state.attributes.intelligence.level}, Carisma Lvl ${state.attributes.charisma.level}, Vitalidade Lvl ${state.attributes.vitality.level}, Criatividade Lvl ${state.attributes.creativity.level}, Sabedoria Lvl ${state.attributes.wisdom.level}, Disciplina Lvl ${state.attributes.discipline.level}. Forneça uma análise motivacional concisa (2-3 frases), aponte o ponto mais forte e sugira 1 área para focar.`;
            try {
                const analysis = await callGeminiAPI(progressSummary);
                DOMElements.progressAnalysisBox.innerHTML = analysis ? analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : 'Não foi possível gerar a análise.';
            } catch (error) { DOMElements.progressAnalysisBox.textContent = 'Ocorreu um erro ao gerar a análise.';
            } finally { setLoading(false, 'analyzeProgress'); }
        }

        async function saveState(userId) {
            if (!userId) {
                try {
                    localStorage.setItem('lifeQuestAIState_local', JSON.stringify(state));
                } catch (e) {
                    console.error("Não foi possível salvar o estado localmente:", e);
                }
                return;
            }
            try {
                const userDocRef = doc(db, 'users', userId);
                await setDoc(userDocRef, state);
            } catch (e) {
                console.error("Não foi possível salvar o estado no Firestore:", e);
            }
        }

        async function loadState(userId) {
            if (userId) {
                const userDocRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    state = Object.assign(getInitialState(), loadedData);
                    console.log("Dados do utilizador carregados do Firestore.");
                } else {
                    console.log("Novo utilizador, a criar novo estado.");
                    state = getInitialState();
                    state.userId = userId;
                    await saveState(userId); 
                }
            } else {
                const savedState = localStorage.getItem('lifeQuestAIState_local');
                if (savedState) {
                    state = Object.assign(getInitialState(), JSON.parse(savedState));
                    console.log("Dados locais carregados.");
                } else {
                    state = getInitialState();
                    state.userId = `local_${crypto.randomUUID()}`; // Assign a temporary ID for local users
                    console.log("Nenhum utilizador logado e sem dados locais. A usar estado inicial com ID local.");
                }
            }
        }
        
        function handleProfilePictureUpload(event) {
             const file = event.target.files[0]; if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => { state.profilePicture = e.target.result; renderAll(); saveState(state.userId); };
             reader.readAsDataURL(file); event.target.value = '';
        }
        
        function handleAddMission(event) {
            event.preventDefault();
            const form = event.currentTarget;
            const modality = form.id.includes('daily') ? 'daily' : (form.id.includes('weekly') ? 'weekly' : 'monthly');
            const limit = modality === 'daily' ? 3 : 1;
            const counterKey = modality === 'daily' ? 'customMissionsTodayCount' : (modality === 'weekly' ? 'customWeeklyThisWeek' : 'customMonthlyThisMonth');
            
            if (state.timers[counterKey] >= limit) return;
            
            const text = DOMElements[`new${modality.charAt(0).toUpperCase() + modality.slice(1)}MissionText`].value.trim();
            const attribute = DOMElements[`new${modality.charAt(0).toUpperCase() + modality.slice(1)}MissionAttribute`].value;

            if (!text) return;
            const xpMap = { daily: 30, weekly: 150, monthly: 500 };
            const newMission = { id: crypto.randomUUID(), text, attribute, xp: xpMap[modality], completed: false, completionTimestamp: null, userCreated: true, };
            
            if (!state.userMissionLibrary.some(m => m.text === text)) {
                state.userMissionLibrary.push({ text, attribute });
            }

            state.missions[modality].push(newMission);
            state.timers[counterKey]++;
            renderAll(); 
            saveState(state.userId);
            form.reset();
        }

        function handleChatActions(event) {
            const addBtn = event.target.closest('.add-mission-btn');
            if (addBtn && !addBtn.disabled) {
                const { text, modality } = addBtn.dataset;
                const attribute = addBtn.dataset.attribute.trim().toLowerCase();

                if (!state.attributes[attribute]) {
                    console.error("Atributo inválido da IA detectado no botão:", attribute);
                    addMessageToChat(`Ocorreu um erro ao tentar adicionar a missão. O atributo "${addBtn.dataset.attribute}" é inválido.`, 'ai');
                    addBtn.textContent = 'Erro!';
                    addBtn.disabled = true;
                    return;
                }
                
                let limit = modality === 'daily' ? 3 : 1;
                let counterKey = modality === 'daily' ? 'customMissionsTodayCount' : (modality === 'weekly' ? 'customWeeklyThisWeek' : 'customMonthlyThisMonth');
                
                if (state.timers[counterKey] >= limit) {
                    addBtn.textContent = 'Limite Atingido!';
                    addBtn.disabled = true;
                    return;
                }
                
                const xpMap = { daily: 30, weekly: 150, monthly: 500 };
                const newMission = { id: crypto.randomUUID(), text, xp: xpMap[modality], attribute, completed: false, completionTimestamp: null, userCreated: true };
                state.missions[modality].push(newMission);
                state.timers[counterKey]++;
                renderAll(); 
                saveState(state.userId);
                addBtn.textContent = 'Adicionada!'; 
                addBtn.disabled = true;
            }
        }

        function handleSwapMission(missionId, missionType) {
             const timerKey = `swapped${missionType.charAt(0).toUpperCase() + missionType.slice(1)}`;
             if (state.timers[timerKey]) return;

             const missionIndex = state.missions[missionType].findIndex(m => m.id === missionId);
             if (missionIndex === -1) return;

             const currentMissionTexts = state.missions[missionType].map(m => m.text);
             const pool = MISSION_POOLS[missionType].filter(m => !currentMissionTexts.includes(m.text));

             if (pool.length > 0) {
                 const newMission = { ...pool[Math.floor(Math.random() * pool.length)], id: crypto.randomUUID(), completed: false, completionTimestamp: null };
                 state.missions[missionType][missionIndex] = newMission;
                 state.timers[timerKey] = true;
                 renderAll();
                 saveState(state.userId);
             }
        }


        function handleCommunityChatSend() {
            const input = DOMElements.communityChatInput;
            const message = input.value.trim();
            if (!message) return;

            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'chat-message user';

            const nameEl = document.createElement('div');
            nameEl.className = 'text-xs text-gray-400 mb-1';
            nameEl.textContent = state.hero.name;
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble chat-bubble-user rounded-2xl p-3 w-fit';
            bubble.textContent = message;

            messageWrapper.appendChild(nameEl);
            messageWrapper.appendChild(bubble);

            DOMElements.communityChatBox.appendChild(messageWrapper);
            DOMElements.communityChatBox.scrollTop = DOMElements.communityChatBox.scrollHeight;
            input.value = '';
        }

        function switchTab(tabId) {
            DOMElements.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
            DOMElements.tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `content-${tabId}`));
        }

        function showCommunityChat(communityName) {
            DOMElements.communityListView.classList.add('hidden');
            DOMElements.communityChatView.classList.remove('hidden');
            DOMElements.communityChatTitle.textContent = communityName;
            const communityTopic = communityName === 'Leitores Vorazes' ? 'Leitura e Livros' : 'Corrida e Fitness';
            
            DOMElements.communityChatBox.innerHTML = `
                <div class="text-center text-xs text-gray-500 py-2">Tópico da Comunidade: <strong>${communityTopic}</strong></div>
                <div class="chat-message other">
                    <div class="text-xs text-cyan-300 mb-1">ISK IA (Admin)</div>
                    <div class="chat-bubble chat-bubble-ai rounded-2xl p-3 w-fit">Bem-vindo à comunidade <strong>${communityName}</strong>!</div>
                </div>
                <div class="chat-message other">
                    <div class="text-xs text-green-300 mb-1">Herói Fitness</div>
                    <div class="chat-bubble chat-bubble-ai rounded-2xl p-3 w-fit">A minha missão bônus é fazer uma boa ação. Alguma ideia?</div>
                </div>
            `;
            lucide.createIcons();

        // Evitar reload nos formulários de criar missão
        [DOMElements.addDailyMissionForm, DOMElements.addWeeklyMissionForm, DOMElements.addMonthlyMissionForm].forEach(form => {
            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                });
            }
        });

        }

        function populateAttributeSelectors() {
            const selectors = [
                DOMElements.newDailyMissionAttribute, 
                DOMElements.newWeeklyMissionAttribute, 
                DOMElements.newMonthlyMissionAttribute
            ];
            const optionsHtml = Object.keys(state.attributes).map(key => 
                `<option value="${key}">${state.attributes[key].name}</option>`
            ).join('');
            selectors.forEach(sel => sel.innerHTML = optionsHtml);
        }

        function showClassSelectionModal() {
            DOMElements.classSelectionContainer.innerHTML = '';
            for (const key in CLASSES) {
                const classInfo = CLASSES[key];
                const card = document.createElement('div');
                card.className = 'class-card bg-gray-900/50 p-6 rounded-lg border-2 border-gray-700 cursor-pointer';
                card.dataset.classKey = key;
                card.innerHTML = `
                    <h3 class="font-game text-lg text-cyan-400 mb-2">${classInfo.name}</h3>
                    <p class="text-sm text-gray-400">Foco em <strong>${state.attributes[classInfo.focus[0]].name}</strong> e <strong>${state.attributes[classInfo.focus[1]].name}</strong>.</p>
                `;
                DOMElements.classSelectionContainer.appendChild(card);
            }
            DOMElements.classSelectionModal.classList.remove('hidden');
        }

        function handleClassSelection(chosenClassKey) {
            state.playerClass = chosenClassKey;
            generateClassMission();
            closeModal();
            renderAll();
            saveState(state.userId);
        }
        
        function handleActivateAbility(abilityKey) {
            const [classKey, levelReq] = abilityKey.split('-');
            const perk = CLASS_PERKS[classKey]?.[levelReq];
            if (!perk) return;

            // Example: 1 day cooldown
            const cooldownDuration = 24 * 60 * 60 * 1000; 
            state.timers.activeAbilityCooldowns[abilityKey] = Date.now() + cooldownDuration;

            // Example: 1 hour duration for the boost
            const boostDuration = 60 * 60 * 1000;
            state.boosts[abilityKey] = Date.now() + boostDuration;
            
            addMessageToChat(`Habilidade Ativa: **${perk.name}** ativada por 1 hora!`, 'ai');

            renderAll();
            saveState(state.userId);
        }

        function showMissionLibraryModal(modality) {
            const listEl = DOMElements.missionLibraryList;
            listEl.innerHTML = '';
            DOMElements.missionLibraryModal.dataset.modality = modality;

            if (state.userMissionLibrary.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center">A sua biblioteca de missões está vazia. Crie missões para as guardar aqui!</p>';
            } else {
                state.userMissionLibrary.forEach(mission => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 bg-gray-700 rounded-lg flex justify-between items-center';
                    itemEl.innerHTML = `
                        <div>
                            <p>${mission.text}</p>
                            <p class="text-xs text-gray-400">${state.attributes[mission.attribute].name}</p>
                        </div>
                        <button class="select-library-mission-btn bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 text-sm rounded-md" data-text="${mission.text}" data-attribute="${mission.attribute}">Usar</button>
                    `;
                    listEl.appendChild(itemEl);
                });
            }
            DOMElements.missionLibraryModal.classList.remove('hidden');
        }

        function selectMissionFromLibrary(text, attribute) {
            const modality = DOMElements.missionLibraryModal.dataset.modality;
            if (!modality) return;

            DOMElements[`new${modality.charAt(0).toUpperCase() + modality.slice(1)}MissionText`].value = text;
            DOMElements[`new${modality.charAt(0).toUpperCase() + modality.slice(1)}MissionAttribute`].value = attribute;
            
            DOMElements.missionLibraryModal.classList.add('hidden');
        }


        function mainTick() {
            updateCountdowns();
            updateAbilityCooldownsDisplay();
        }

        function updateAbilityCooldownsDisplay() {
            const now = Date.now();
            const abilityButtons = document.querySelectorAll('.activate-ability-btn[disabled]');
            let needsRender = false;
            
            abilityButtons.forEach(button => {
                const abilityKey = button.dataset.abilityKey;
                const cooldownEnd = state.timers.activeAbilityCooldowns[abilityKey];
                if (cooldownEnd) {
                    if (now < cooldownEnd) {
                        button.textContent = `Em Recarga (${formatCountdown(cooldownEnd - now)})`;
                    } else {
                        delete state.timers.activeAbilityCooldowns[abilityKey];
                        needsRender = true;
                    }
                }
            });

            if (needsRender) {
                renderPerks();
                lucide.createIcons();

        // Evitar reload nos formulários de criar missão
        [DOMElements.addDailyMissionForm, DOMElements.addWeeklyMissionForm, DOMElements.addMonthlyMissionForm].forEach(form => {
            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                });
            }
        });

            }
        }
        
        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Erro na autenticação com Google:", error);
                });
        } */

        function init() {
            populateAttributeSelectors();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    DOMElements.authButtons.classList.add('hidden');
                    DOMElements.logoutSection.classList.remove('hidden');
                    DOMElements.userEmail.textContent = `Bem-vindo, ${user.displayName || user.email}!`;
                    await loadState(user.uid);
                } else {
                    DOMElements.authButtons.classList.remove('hidden');
                    DOMElements.logoutSection.classList.add('hidden');
                    state = getInitialState(); // Reset state on logout
                    await loadState(null); 
                }
                checkAndGenerateMissions(); 
                renderAll();
            });

            DOMElements.tabs.forEach(tab => tab.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab)));
            DOMElements.closeModalBtn.addEventListener('click', closeModal);
            document.getElementById('content-tasks').addEventListener('click', (e) => { 
                const completeButton = e.target.closest('.complete-btn');
                const swapButton = e.target.closest('.swap-btn');
                const showLibraryButton = e.target.closest('.show-library-btn');
                if (completeButton) { completeTask(completeButton.dataset.missionId, completeButton.dataset.missionType); }
                if (swapButton) { handleSwapMission(swapButton.dataset.missionId, swapButton.dataset.missionType); }
                if (showLibraryButton) { showMissionLibraryModal(showLibraryButton.dataset.modality); }
            });

            DOMElements.closeLibraryBtn.addEventListener('click', () => DOMElements.missionLibraryModal.classList.add('hidden'));
            DOMElements.missionLibraryList.addEventListener('click', (e) => {
                const selectBtn = e.target.closest('.select-library-mission-btn');
                if (selectBtn) {
                    selectMissionFromLibrary(selectBtn.dataset.text, selectBtn.dataset.attribute);
                }
            });

            DOMElements.profilePictureContainer.addEventListener('click', () => DOMElements.profilePictureInput.click());
            DOMElements.profilePictureInput.addEventListener('change', handleProfilePictureUpload);
            
            DOMElements.addDailyMissionForm.addEventListener('submit', handleAddMission);
            DOMElements.addWeeklyMissionForm.addEventListener('submit', handleAddMission);
            DOMElements.addMonthlyMissionForm.addEventListener('submit', handleAddMission);

            DOMElements.heroNameInput.addEventListener('change', (e) => { state.hero.name = e.target.value || 'Herói'; renderCharacterSheet(); saveState(state.userId); });
            DOMElements.analyzeProgressBtn.addEventListener('click', handleProgressAnalysis);
            DOMElements.aiSendBtn.addEventListener('click', handleAISubmit);
            DOMElements.aiChatbox.addEventListener('click', handleChatActions);
            DOMElements.aiInput.addEventListener('keypress', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAISubmit(); }});
            
            DOMElements.communityList.addEventListener('click', (e) => { const btn = e.target.closest('.join-community-btn'); if(btn) showCommunityChat(btn.dataset.communityName); });
            DOMElements.backToCommunitiesBtn.addEventListener('click', () => { DOMElements.communityChatView.classList.add('hidden'); DOMElements.communityListView.classList.remove('hidden'); });
            DOMElements.communityChatSendBtn.addEventListener('click', handleCommunityChatSend);
            DOMElements.communityChatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); handleCommunityChatSend(); }});
            
            DOMElements.classSelectionContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.class-card');
                if (card) { handleClassSelection(card.dataset.classKey); }
            });
            document.getElementById('content-profile').addEventListener('click', (e) => {
                const button = e.target.closest('.activate-ability-btn');
                if (button && !button.disabled) {
                    handleActivateAbility(button.dataset.abilityKey);
                }
            });

            DOMElements.googleLoginBtn.addEventListener('click', signInWithGoogle);
            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            
            DOMElements.themeSelector.addEventListener('change', (e) => {
                document.body.dataset.theme = e.target.value;
                state.theme = e.target.value;
                saveState(state.userId);
            });

            DOMElements.resetAccountBtn.addEventListener('click', () => {
                DOMElements.confirmationModal.classList.remove('hidden');
                DOMElements.confirmAcceptBtn.onclick = async () => {
                    state = getInitialState();
                    if (auth.currentUser) {
                        await saveState(auth.currentUser.uid);
                    } else {
                        saveState(null); // Save to localStorage for logged-out user
                    }
                    DOMElements.confirmationModal.classList.add('hidden');
                    location.reload(); // Reload to apply fresh state
                };
                DOMElements.confirmCancelBtn.onclick = () => {
                    DOMElements.confirmationModal.classList.add('hidden');
                };
            });

            DOMElements.toggleCreateMissionBtn.addEventListener('click', () => {
                const content = DOMElements.createMissionContent;
                const chevron = DOMElements.createMissionChevron;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    chevron.style.transform = 'rotate(180deg)';
                }
            });
            
            setInterval(mainTick, 1000); 
            setInterval(checkAndGenerateMissions, 60000); 
        }

        init();
    });
    </script>
</body>
</html>

